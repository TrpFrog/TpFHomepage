<!DOCTYPE html>
<html lang="ja">
    
    <head>
        <meta name="robots" content="noindex">
        <script type="text/javascript" src="/contents_builder.js"></script>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <!-- StyleSheet -->
        <style>
            @import "/stylesheets/common/grid.css";
            @import "/stylesheets/common/header.css";
            @import "/stylesheets/common/footer.css";
            @import "/stylesheets/common/h2icon.css";
            @import "/stylesheets/common/page_elements.css";
            @import "/stylesheets/common/linkbutton.css";
            @import "/stylesheets/common/media.css";
            @import "/stylesheets/blog/blogtag.css";
            @import "/stylesheets/blog/article.css";
        </style>
        
        <!--- Highlight.js --->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/monokai-sublime.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <!---------------->
        
        <!--- MathJax --->
        <script>
        MathJax = {
            chtml: {
                matchFontHeight: false
            },
            tex: {
              inlineMath: [['$', '$']]
            }
        };
        </script>
        <script id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
        <!--------------->
        
        <!--lite-youtube-->
        <link rel="stylesheet" href="/library/lite-youtube-embed/src/lite-yt-embed.css">
        <script src="/library/lite-youtube-embed/src/lite-yt-embed.js"></script>
        <!---------------->
        
        <meta charset="utf-8">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@TrpFrog">
        <meta property="og:url" content="https://trpfrog.net">
        <meta property="og:title" content="雑記「おうちMac+PythonでLINE botを作る」 - つまみネット">
        <meta property="og:description" content="オウム返しするまでのメモ</>">
        <meta property="og:image" content="https://trpfrog.net/notes/line-bot/thumbnail.webp">
        <title>雑記「おうちMac+PythonでLINE botを作る」 - つまみネット</title>
    </head>
    
    <body>
        <div class="grid">
            <header></header>
            <main>
                <div id="main_wrapper">
                    <div id="title">
                        <h1>おうちMac+PythonでLINE botを作る</h1>
                        <p>
                            <span style="display: inline-block;">2021年10月12日</span>
                            <span style="display: inline-block;">(更新: 2021年10月12日)</span><br>
                            <b>Tags: </b> <span class="article_tag">技術</span>
                        </p>
                        <p>
                            <a href="../index.html" class="linkButton">記事一覧</a>
                            <script>
                                let tweet_link = '<a href="' + getTwitterUrl() + '" class="linkButton" style="margin-left: 5px">記事をツイート</a>';
                                document.write(tweet_link);
                            </script>
                            <a href="https://github.com/TrpFrog/trpfrog-net/tree/master/notes/line-bot/index.md" class="linkButton">修正を提案</a>
                        </p>
                    </div>
                    <div class="main_window">
                        <p>導入までの覚え書き。オウム返しbotを作ることをゴールとします。(雑なので気が向いたら書き直すかもしれない)</p>
<h2>LINE Developer に登録する</h2>
<p><a href="https://developers.line.biz/ja/">ここ</a>から頑張るとできる。</p>
<h2>Messanging API のチャネルを作る</h2>
<p>Providerを選んでMessanging API のチャネルを作る。できたら</p>
<ul>
<li><strong>チャネルシークレット</strong><ul>
<li>チャネル基本設定のタブにある</li>
</ul>
</li>
<li><strong>チャネルアクセストークン</strong><ul>
<li>Messaging API設定のタブにある</li>
</ul>
</li>
</ul>
<p>をメモしておく。あとで使う。</p>
<h2>LINE Messaging API SDK for Python の導入</h2>
<p>次に<a href="https://github.com/line/line-bot-sdk-python">ここ</a>のReadmeの通りに</p>
<pre><code class="language-console">$ pip install line-bot-sdk
</code></pre>
<p>する。Flaskを入れてなかったら</p>
<pre><code class="language-console">$ pip install flask
</code></pre>
<p>もする。</p>
<p>Readmeの<a href="https://github.com/line/line-bot-sdk-python#synopsis">サンプルコード</a>をそのままもらって <code>mylinebot.py</code> として保存しておく。</p>
<p>このときさっきメモした<strong>チャネルシークレット</strong>と<strong>チャネルアクセストークン</strong>をサンプルコードの対応する部分に貼り付ける。</p>
<h2>Let's Encrypt で証明書の準備</h2>
<p>LINEのAPIには<strong>Webhook</strong>が必須、かつ<strong>SSL対応</strong>のCallback URLが必要なのでこれをする必要がある。無理におうちでやる必要がないのならば<a href="https://jp.heroku.com/">Heroku</a>でやった方が早い<a href="https://twitter.com/Prgckwb/status/1447625501590228996">らしい</a>。でもおうち環境で完結させたいので頑張る。SSL対応は<strong>Let's Encrypt</strong>を使う。(オレオレ証明書だとLINEくんに弾かれるので)</p>
<p>ここで</p>
<ul>
<li>おうちにつながるドメイン<ul>
<li><code>ouchi.trpfrog.net</code> みたいな</li>
</ul>
</li>
<li>80番のポート開放</li>
</ul>
<p>が必要になるので準備しておく。したら次に<strong>certbot</strong>を入れる。(Homebrewが必要)</p>
<pre><code class="language-console">$ brew install certbot
</code></pre>
<p>次を実行。</p>
<pre><code class="language-console">$ sudo certbot certonly --manual 
</code></pre>
<p>いろいろ聞かれるので従う。最後に「.well_known/acme-challenge/<strong>XXXXXX</strong>」に<strong>YYYYYY</strong>を書いたファイルを用意してね、と言われるので準備する。その後、Webサーバを立ち上げて外部からそのファイルにアクセスできるようにする。つまり</p>
<pre><code class="language-text">http://ouchi.trpfrog.net/.well_known/acme-challenge/XXXXXX
</code></pre>
<p>から指定された文字列 <code>YYYYYY</code> のテキストファイルが得られるようにすれば良い。</p>
<p>ここはFlaskを使ってやっても良いのだけれども、いまいち書き方がよくわからなかったので(え？) Dockerでnginx呼び出して殴ってしまった。</p>
<pre><code class="language-console">$ docker run docker run -d -p 80:80 \
    -v $PWD:/usr/share/nginx/html \
    --name lets-tmp \
    nginx
</code></pre>
<p>Webサーバ立ち上げたらつながることを確認してcertbotを続行。うまくいくとどこかに</p>
<ul>
<li><code>fullchain.pem</code></li>
<li><code>privkey.pem</code></li>
</ul>
<p>ができるので、そのパスをメモしておく。</p>
<h2>Webhookに使うサーバを起動</h2>
<p>ここまでいったら起動する、がサンプルコードのままだと不都合なのでちょっと書き加える。</p>
<pre><code class="language-python">app.run()
</code></pre>
<p>を</p>
<pre><code class="language-python">app.run(host='自分のローカルIP', port=80, ssl_context=(
    'fullchain.pemへのパス', 
    'privkey.pemへのパス'
))
</code></pre>
<p>にする。これで実行する。<code>ouchi.trpfrog.net</code> にアクセスしてコンソールに反応があればOK。</p>
<h2>Callback URLを登録</h2>
<p>ここまでできたら、LINEのMessaging API設定からWebhookを登録する。</p>
<pre><code class="language-text">https://ouchi.trpfrog.net/callback
</code></pre>
<p>みたいな感じで良い。<strong>検証</strong>をクリックして<a href="https://twitter.com/shinjirokoiz">うまくいけば成功</a>。</p>
<h2>やってみる</h2>
<p>同じくMessaging API設定にQRコードがあるはずなので友達登録してみる。</p>
<p>なんか喋ってオウム返しされたら成功！お疲れ様でした。</p>
<p style="text-align: center;"><img alt="thumbnail" src="thumbnail.webp"/></p>
                    </div>
                    <div class="main_window" style="background-color: transparent; margin: 0; padding: 0 20px;">
                        <p>
                            <a href="../index.html" class="linkButton">記事一覧</a>
                            <script>
                                document.write(tweet_link);
                            </script>
                            <a href="https://github.com/TrpFrog/trpfrog-net/tree/master/notes/line-bot/index.md" class="linkButton">修正を提案</a>
                        </p>
                    </div>
                </div>
            </main>
            <footer></footer>
        </div>
    </body>
</html>
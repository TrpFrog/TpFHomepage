<!DOCTYPE html>
<html lang="ja">
    
    <head>
        <meta name="robots" content="noindex">
        <script type="text/javascript" src="/contents_builder.js"></script>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <!-- StyleSheet -->
        <style>
            @import "/stylesheets/common/grid.css";
            @import "/stylesheets/common/header.css";
            @import "/stylesheets/common/footer.css";
            @import "/stylesheets/common/h2icon.css";
            @import "/stylesheets/common/page_elements.css";
            @import "/stylesheets/common/linkbutton.css";
            @import "/stylesheets/common/media.css";
            @import "/stylesheets/blog/blogtag.css";
            @import "/stylesheets/blog/article.css";
        </style>
        
        <!--- Highlight.js --->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/monokai-sublime.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <!---------------->
        
        <!--- MathJax --->
        <script>
        MathJax = {
            chtml: {
                matchFontHeight: false
            },
            tex: {
              inlineMath: [['$', '$']]
            }
        };
        </script>
        <script id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
        <!--------------->
        
        <!--lite-youtube-->
        <link rel="stylesheet" href="/library/lite-youtube-embed/src/lite-yt-embed.css">
        <script src="/library/lite-youtube-embed/src/lite-yt-embed.js"></script>
        <!---------------->
        
        <meta charset="utf-8">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@TrpFrog">
        <meta property="og:url" content="https://trpfrog.net">
        <meta property="og:title" content="雑記「Disnake + GitHub Actions で作るオタク鯖晒しサイト」 - つまみネット">
        <meta property="og:description" content="変なオタク鯖のチャンネルを晒すサイトを作った</>">
        <meta property="og:image" content="https://trpfrog.net/notes/otaku-channels/thumbnail.webp">
        <title>雑記「Disnake + GitHub Actions で作るオタク鯖晒しサイト」 - つまみネット</title>
    </head>
    
    <body>
        <div class="grid">
            <header></header>
            <main>
                <div id="main_wrapper">
                    <div id="title">
                        <h1>Disnake + GitHub Actions で作るオタク鯖晒しサイト</h1>
                        <p>
                            <span style="display: inline-block;">2021年12月16日</span>
                            <span style="display: inline-block;">(更新: 2021年12月20日)</span><br>
                            <b>Tags: </b> <span class="article_tag">大学</span><span class="article_tag">技術</span>
                        </p>
                        <p>
                            <a href="../index.html" class="linkButton">記事一覧</a>
                            <script>
                                let tweet_link = '<a href="' + getTwitterUrl() + '" class="linkButton" style="margin-left: 5px">記事をツイート</a>';
                                document.write(tweet_link);
                            </script>
                            <a href="https://github.com/TrpFrog/trpfrog-net/tree/master/notes/otaku-channels/index.md" class="linkButton">修正を提案</a>
                        </p>
                    </div>
                    <div class="main_window">
                        <p style="text-align: center;"><img alt="" src="thumbnail.webp"/></p>
<p><strong>何？これは</strong></p>
<p>この記事は <strong><a href="https://adventar.org/calendars/6598">UEC 2 Advent Calendar 2021</a></strong> 16日目の記事です。飛び入り参加です。</p>
<p>先日の記事はNasatameさんの「<strong>最近見ているYouTubeの話</strong>」でした。</p>
<p><a href="https://nasatame.hatenablog.com/entry/2021/12/13/073814">https://nasatame.hatenablog.com/entry/2021/12/13/073814</a></p>
<p>面白そうなチャンネルが5つも紹介されています。特に3位のサイトは僕が吹奏楽部だったときに参考音源としてたまに聴いていたのですが、他にも色々なジャンルの動画が出されているそうでかなり気になってしまいました。</p>
<h2>あなたは誰？</h2>
<p>こんにちは！uec19の<strong>つまみ</strong>です。先日はアドカレその1にぶん投げた <strong><a href="https://trpfrog.hateblo.jp/entry/c2walker">中央環状線一周記事</a></strong> で皆さんの通信量を破壊してしまい申し訳ありません。まだ未読の方はおうちWi-Fiとかで読んでください。</p>
<p>さて、皆さんはDiscordサーバーに入ったら<strong>粗悪なチャンネルを大量生産するバカタレがいた</strong>という経験はありますでしょうか？そうですよね、困りますよね。</p>
<p style="text-align: center;"><img src="channels.webp" style="zoom:70%;"/></p>
<p>僕のいるサーバはこんなのが<strong>250個</strong>近くあり最悪です。</p>
<p>今回はそんな最悪なサーバの<strong>チャンネル一覧をインターネットに公開して</strong>懲らしめてやろうと思います。</p>
<h2>作戦</h2>
<p><strong>チャンネル乱立オタクは毎日チャンネルを作る</strong>ので手作業でチャンネルをまとめると僕の大切な時間が失われてしまいます。そこで <strong>Discord API</strong> を叩いてチャンネル一覧を手に入れましょう。<strong>Pythonを使えば簡単そう</strong>なのでDiscord APIラッパーライブラリの <strong>Disnake</strong> を使うことにします。</p>
<p>さらに Discord API が叩けても手作業で毎日更新するのはつらいので <strong>GitHub Actions</strong> を使って毎日勝手に更新されるようにします。公開先はみんな大好き <strong>GitHub Pages</strong> です。GitHub Pages を使うと簡単に自分のホームページが作れたりするのでHP作りに興味がある人は調べてみると良いでしょう。</p>
<h3>Discord とは</h3>
<p style="text-align: center;"><img alt="" src="discord.webp"/></p>
<p><a href="https://discord.com"><strong>Discord</strong></a> については <a href="https://asunarowasabi.hatenablog.jp/entry/2021/12/12/235143">UEC Advent Calendar 2021 12日目のあすなろわさび先生</a>が書いて下さっているのでそちらを引用したいと思います。</p>
<blockquote>
<p>当初はゲーマー向けコミュニケーションツールとして始まり、今ではコロナ禍も相まって主要なSNSの一つとなりつつあります。</p>
</blockquote>
<p>なるほど！引用終わり</p>
<h3>Disnake とは</h3>
<p style="text-align: center;"><img alt="" src="disnake.webp"/></p>
<p>Python から簡単に Discord API を叩ける便利ライブラリといえば <strong>discord.py</strong> が有名でしたが、なんとこの前<strong>開発終了</strong>が発表されてしまいました。</p>
<p>(まだ使えなくはないんだろうけど) 代替手段はないか……と探したところ、<strong><a href="https://github.com/DisnakeDev/disnake">Disnake</a></strong> という discord.py の fork を見つけました。ちょこちょこメンテナンスされてそうなので今回はこちらを使ってみることにします。</p>
<h3>GitHub Actions とは</h3>
<p><a href="https://github.co.jp/features/actions"><strong>GitHub Actions</strong></a> はpush時や特定の時間に勝手にスクリプトを動かしてくれる便利ツールです。今回はこいつを使って</p>
<ul>
<li>Discord API を叩いて</li>
<li>jsファイル (チャンネルのデータ) を吐いて</li>
<li>GitHub Pages で公開する</li>
</ul>
<p>を<strong>毎日</strong>やらせようと思います。</p>
<h2>やってみる</h2>
<h3>1. bot を作る</h3>
<p>まずチャンネル情報を入手するために <a href="https://discord.com/developers/applications">Discord Developer Portal</a> で Discord の botを作ります。</p>
<p style="text-align: center;"><img alt="" src="bot.webp"/></p>
<p>このスパイをとりあえず<strong>変なオタクサーバーに侵入</strong>させます。</p>
<p style="text-align: center;"><img alt="" src="join.webp"/></p>
<p>上手く忍び込めたようです。<strong>botの設定ページからTokenが貰える</strong>のでこれを使ってチャンネル一覧を吐くコードを書いてみましょう。</p>
<h3>2. チャンネル一覧を出力してみる</h3>
<p>コードを書いてみます。ま〜る書いて……</p>
<pre><code class="language-python">import disnake

client = disnake.Client()

TOKEN = 'DISCORD_BOT_TOKEN'
GUILD_ID = int('DISCORD_GUILD_ID')  # サーバのID

@client.event
async def on_ready():
    categories = client.get_guild(GUILD_ID).categories

    for category in categories:
        print(category.name)
        for ch in category.text_channels:
            print('    ' + ch.name)

    await client.close()


if __name__ == '__main__':
    client.run(TOKEN)
</code></pre>
<p>フォイ！できました！実行してみましょう！</p>
<p style="text-align: center;"><img alt="" src="channelstest.webp"/></p>
<p>ちゃんと一覧が出ていていい感じです。</p>
<p>今回はウェブで公開したいのでこれを更に<strong>いい感じの形式</strong>で出力する必要があります。HTMLファイルを頑張って吐かせてもよいのですが、今回はJavaScriptの配列を作って <strong>channels.js</strong> として保存してみましょう。こうするとあとで扱いやすくて便利です。</p>
<p>そんなわけでちょっと改良して吐いてみます。</p>
<pre><code class="language-python">import os
from typing import Optional
import disnake
client = disnake.Client()

TOKEN = 'DISCORD_BOT_TOKEN'
GUILD_ID = int('DISCORD_GUILD_ID')

@client.event
async def on_ready():
    categories = client.get_guild(GUILD_ID).categories
    js += 'const categories = ['
    for category in categories:
        js += '{'
        js += f'"name": "{category.name}",'
        js += '"channels": ['
        for ch in category.text_channels:
            js += '{'
            js += f'"name": "{ch.name}",'
            js += f'"topic": "{ch.topic}",'
            js += '},'
        js += ']},'
    js += '];'

    with open('pages/channels.js', 'w', encoding='utf-8') as f:
        f.write(js)

    await client.close()

if __name__ == '__main__':
    client.run(TOKEN)
</code></pre>
<p>なんかゴリゴリしてますが頑張ってやるとこんな感じです。動かしてみましょう！</p>
<p style="text-align: center;"><img alt="" src="array.webp"/></p>
<p>気持ち悪いファイルが出てきました。しかし、これは<strong>JavaScriptには配列に見える</strong>のでWebページに組み込むのがかなり簡単になりました！更に頑張ってコードを書いて綺麗に出力すると<a href="https://github.com/TrpFrog/otaku-channels/blob/gh-pages/channels.js">こんな感じ</a>です。</p>
<p>データをjsファイルで保存しておくやり方は若干抵抗感がありますが、Twitter社も<strong>tweets.js</strong>とか言ってやってるのでOKです。たぶん</p>
<h3>3. 実際にサイトを作ってみる</h3>
<p>簡単なウェブページを作ってみましょう。適当に<a href="https://twitter.com/is2013_sub/status/1219563789336510466">doctype html html head meta charset title…</a> すると完成しますね。</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;script type="text/javascript" src="channels.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="builder.js"&gt;&lt;/script&gt;
        &lt;title&gt;Otaku Discord Channels&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1 id="title"&gt;Otaku Discord Channels&lt;/h1&gt;
        &lt;div id="content"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>おっと！これだけだとまだ足りないのでJavaScriptも書きます。</p>
<pre><code class="language-javascript">function writeChannels() {
    document.getElementById('title').innerHTML = serverName;
    let html = '&lt;ul&gt;';
    for (const category of categories) {
        html += '&lt;li&gt;' + category.name + '&lt;/li&gt;';
        html += '&lt;ul&gt;';
        for (const channel of category.channels) {
            html += '&lt;li&gt;' + channel.name + '&lt;/li&gt;';
            if (channel.hasTopic) {
                html += '&lt;ul&gt;&lt;li&gt;' + channel.topic + '&lt;/li&gt;&lt;/ul&gt;';
            }
        }
        html += '&lt;/ul&gt;';
    }
    html += '&lt;/ul&gt;';
    document.getElementById('content').innerHTML = html;
}

onload = writeChannels;
</code></pre>
<p>できました。先ほどPythonに生成させた <code>categories</code> 配列を使ってサイトに組み込んでいます。動かしてみましょう。</p>
<p style="text-align: center;"><img alt="" src="simplewebsite.webp"/></p>
<p>いい感じに出力されました！もうちょい上手く手直ししたり<strong>CSSを書いたり</strong>するとこうなります。</p>
<p style="text-align: center;"><img alt="" src="otaku-channels.webp"/></p>
<p>良い感じです！<strong>254チャンネルは多すぎるだろ</strong></p>
<h3>4. Actions Secret を使う</h3>
<p>さて、サイトも完成したことですし<strong>GitHubに公開しましょう</strong>。</p>
<p>……</p>
<p>そうです、まだ一つやらなければならない<strong>とても重要なこと</strong>がありました。<strong>人に知られてはならないbotのTokenがプログラムに直接書かれています</strong>。これをpushするわけにはいきません！でもGitHub Actionsくんに実行させたいので<strong>tokenは必須</strong>です。どうすればよいでしょうか？</p>
<p>そこで環境変数とActions Secretという機能を使います。実はGitHub Actionsでは<strong>秘密にしたい情報を隠しておく機能</strong>があります。</p>
<p style="text-align: center;"><img alt="" src="secret.webp"/></p>
<p>リポジトリの設定の Secrets -&gt; Actions にあります。この値には GitHub Actions に使うファイルからアクセスすることができます。更にこれを<strong>環境変数にできる</strong>ので、Pythonのコードもそんな感じで書き換えていましょう。</p>
<pre><code class="language-python">TOKEN = 'DISCORD_BOT_TOKEN'
GUILD_ID = int('DISCORD_GUILD_ID')  # サーバのID
</code></pre>
<p>こんな感じの貧弱なコードだったので……</p>
<pre><code class="language-python">import os
TOKEN: Optional[str] = os.environ.get('DISCORD_BOT_TOKEN')
GUILD_ID = int(os.environ.get('DISCORD_GUILD_ID'))
</code></pre>
<p>として<strong>環境変数からTokenを手に入れられるように</strong>します。自分の開発環境にも環境変数を設定しておきましょう。これで安全にpushする準備ができました。pushしてしまいましょう！</p>
<h3>5. GitHub Actions を使う</h3>
<p>さて、pushしたのは良いですがこのままだと何も起きません。pushされると</p>
<ul>
<li>Pythonスクリプトを実行して</li>
<li>channels.js を出力して</li>
<li>GitHub Pages 上で公開する</li>
</ul>
<p>ようにしたいです。そこで <strong>GitHub Actions</strong> を使います。</p>
<p>リポジトリの Actions タブから新しい workflow を作ります。</p>
<p style="text-align: center;"><img alt="" src="actions.webp"/></p>
<p>するとエディタが出てくるのでこんな感じで書きます。</p>
<pre><code class="language-yaml">name: Deploy website

on:
  push:
    branches: [ main ] # pushしたら実行
  pull_request:
    branches: [ main ] # PRが来たら実行
  schedule:
    - cron: '0 0 * * *' # 毎朝9時に実行

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

            # Python の実行準備
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: 'x64'

            # ライブラリ (disnake) のインストール
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 実行
      - name: Run Python
        # 環境変数の設定 (Tokenの設定！！！！)
        env:
            DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
            DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
        run: python fetcher.py

            # GitHub Pages に反映させる
      - name: Deploy website
        uses: peaceiris/actions-gh-pages@v3
        with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: pages # pagesフォルダを公開する

</code></pre>
<p>こうです。意味不明なのでコメントだけ読んで雰囲気を理解してもらえればOKです。こうすると毎朝9時に</p>
<ul>
<li>変なオタクサーバからチャンネル情報を落として</li>
<li>GitHub Pages で公開する</li>
</ul>
<p>流れを<strong>勝手に</strong>やってくれます。便利ですね！<strong>何が？</strong></p>
<h3>6. 完成！</h3>
<p>~~という感じで無事 https://trpfrog.github.io/otaku-channels/ でサイトを公開することができました。正しく動いていれば明日以降も更新され続けると思われます。(なにせ記事を書いた今完成したため……(は？))~~</p>
<p><strong>12/20追記:</strong> ちゃんと毎日更新されていました！が、諸事情により GitHub Pages での公開をやめました。詳しくは記事の最後に追記したのでお読みください。新URLはこちらです: <a href="https://otaku-discord.trpfrog.net">otaku-discord.trpfrog.net</a></p>
<p style="text-align: center;"><img alt="" src="otaku-channels.webp"/></p>
<h2>余談</h2>
<p style="text-align: center;"><img alt="" src="xss.webp"/></p>
<p>この話を聞いたオタクがウキウキしながら<strong>XSS(?)を仕掛けて来やがった</strong>のでサニタイズライブラリの<a href="https://github.com/mozilla/bleach"><strong>bleach</strong></a>を使って殺してやりました。</p>
<pre><code class="language-python">import bleach
topic = bleach.clean(channel.topic)
</code></pre>
<p>めでたしめでたし。</p>
<p>bleachはMozillaが作っているらしいです。</p>
<h2>終わりに</h2>
<p>今回は毎日GitHub ActionsにDiscord APIでオタクサーバを訪問させてチャンネルを晒すサイトを作りました。皆さんも<strong>チャンネル乱立オタクがいて困った時</strong>はやってみてください。</p>
<p>~~次回は19日のmarbleさんの記事です。後でリンクを貼ります。17, 18が空いているので僕みたいに急に書きたくなった人がいたら書きましょう！~~</p>
<p>次回は17日のごっちさんの記事「<strong>猫でもわかるファイルサーバ構築</strong>」です。</p>
<p><a href="https://gotti.dev/post/uecadvent2021_fileserver/">https://gotti.dev/post/uecadvent2021_fileserver/</a></p>
<p>18日もBさんの記事で埋まったみたいですし、UEC 2 Advent Calendar の後半は全部埋まったみたいです。<strong>すごい</strong></p>
<p>それでは、さようなら</p>
<h2>12月20日 追記: やっぱりGitHub Pagesはやめた</h2>
<p>この記事で紹介した方法には一つだけ、<strong>非常に大きな問題点</strong>がありました。それはGitHubの<strong>Contributions</strong>に影響が出ることです。<strong>草が自動で生え続けます。</strong></p>
<p>草が生えると嬉しいですが、自分は何もしていないのに草が生えるのはそれはそれで結構しんどいです。<strong>チート感マシマシ</strong>です。そこで外部のホスティングサービスを使ってみることにしました。</p>
<p>まずはこのつまみネットでも使っている <strong>Cloudflare Pages</strong> です。<strong>ビルド時間がバカ長い</strong>という欠点がありますが、サイトアクセスは速いし私も使い慣れているので良さそうです。</p>
<p>しかし、こちらはこちらで問題がありました。Cloudflare Pages では Python の最新バージョンが <strong>3.7</strong> なのです。実は今回使っている<strong>disnakeの必須要件が Python 3.8 以上</strong>なので、無理です。他のところにしましょう。</p>
<p>そこで今回は Vercel を使うことにします。なんと最近 Python <strong>3.9</strong> が使えるようになった？みたいなのでバージョン問題はクリアです。早速設定します。</p>
<p style="text-align: center;"><img alt="" src="vercel.webp"/></p>
<p>Vercel と GitHub を連携してはいはい設定を進めると上のような画面に出ます。</p>
<ul>
<li>BUILD COMMAND に channels.js を吐くPythonコマンドを入れ、</li>
<li>OUTPUT DIRECTORY にHTMLファイルなどのある pages フォルダを指定し、</li>
<li>INSTALL COMMAND にdisnakeなどをインストールするコマンドを入れ、</li>
<li>Environment Variables にTokenなどを入れて</li>
</ul>
<p>Deployを押すとデプロイが始まります。するとなんとこれだけでうまくデプロイされました。<strong>簡単すぎ！</strong></p>
<p>次に定期実行の設定をします。定期的なデプロイ自体は (おそらく) Vercel単体ではできないのでGitHub Actionsを使います。</p>
<p style="text-align: center;"><img alt="" src="deploy-hook.webp"/></p>
<p>まずはVercelの設定から git → <strong>Deploy Hooks</strong> に入ると「<strong>叩くと勝手にデプロイが始まるリンク</strong>」が手に入るのでそれをもらいます。</p>
<p>次に GitHub Actions の自動デプロイに使った <code>main.yml</code> を次のように書き換えます。</p>
<pre><code class="language-yaml">name: Deploy website

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
        # ここで Deploy Hook を叩く
      - run: curl -X POST ${{ secrets.DEPLOY_HOOK }}
</code></pre>
<p>Deploy Hook は知られるとまずいので、先にも書いたように Actions Secret を使うと良いでしょう。</p>
<p>これでGitHubに草を生やさずに定期デプロイされるウェブサイトを作ることができました！ちなみに gh-pages ブランチを消去したら過去の草も消えてくれました。めでたしめでたし</p>
<p><a href="https://github.com/TrpFrog/otaku-channels">GitHub上にコードを載せている</a>ので似たようなお悩みを抱えている方はぜひやってみてください♪ それではまた次回の記事でお会いしましょう！さようなら</p>
                    </div>
                    <div class="main_window" style="background-color: transparent; margin: 0; padding: 0 20px;">
                        <p>
                            <a href="../index.html" class="linkButton">記事一覧</a>
                            <script>
                                document.write(tweet_link);
                            </script>
                            <a href="https://github.com/TrpFrog/trpfrog-net/tree/master/notes/otaku-channels/index.md" class="linkButton">修正を提案</a>
                        </p>
                    </div>
                </div>
            </main>
            <footer></footer>
        </div>
    </body>
</html>